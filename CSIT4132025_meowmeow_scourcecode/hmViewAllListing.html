<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <title>Homeowners All Cleaning Services</title>
        <link rel="stylesheet" href="css/style.css" />
    </head>
    <body class="homeowners-page">
        <div class="homeownersHeaderBanner">
            <a href="homeownersPage.html">
            <img src="C2Ccleaningservicelogo.png" alt="logo" class="logo-img"/>
            </a>
            <a href="HMViewAllCS.html" class="services-menu">All Cleaning Services</a>
            <a href="hmViewAllListing.html" class="services-menu">All Cleaning Services2</a>
            <a href="hmViewBKHistory.html" class="services-menu">Booking History</a>
            <a href="HMFavourites.html" class="services-menu">Favourites</a>
            <a href="loginPage.html" class="logoutBtn" id="logout">Logout</a>
        </div>

        <main>
            <div class="view-CS">
            <div class="CS">
                <select id="categoryFilter">
                <option value="">All Categories</option>
                <option value="Deep Cleaning">Deep Cleaning</option>
                <option value="General House Cleaning">General House Cleaning</option>
                <option value="Move In or Out Cleaning">Move In or Out Cleaning</option>
                <option value="Office & Commercial Cleaning">Office & Commercial Cleaning</option>
                <option value="Pet-Friendly Cleaning">Pet-Friendly Cleaning</option>
                <option value="Post-Construction Cleaning">Post-Construction Cleaning</option>
                <option value="Specialized Cleaning">Specialized Cleaning</option>
                </select>

                <select id="statusFilter">
                <option value="">All Status</option>
                <option value="available">Available</option>
                <option value="unavailable">Unavailable</option>
                </select>

                <select id="priceFilter">
                <option value="">All Prices</option>
                <option value="0-50">$0 - $50</option>
                <option value="51-100">$51 - $100</option>
                <option value="101-200">$101 - $200</option>
                <option value="201-500">$201 - $500</option>
                </select>

                <button id="searchBtn">Search</button>
            </div>
            </div>

            <div id="servicesContainer" class="services-container"></div>

            <!-- Modal for updating service category -->
            <!-- Update Modal -->
            <div id="detailsModal" class="modal" style="display:none;">
                <div class="modal-content">
                <span class="close-btn" id="closeModalBtn-details">&times;</span>
                <h3>Details of the service</h3>
                <form id="details-form">

                    <label for="details-service-category">Service Category:<span id="details-service-category"></span></label>
                    <label for="details-service-name">Service Name:<span id="details-service-name"></span></label>
                    <label for="details-service-fee">Fee:<span id="details-service-fee"></span></label>
                    <label for="details-service-frequency">Frequency:<span id="details-service-frequency"></span></label>
                    <label for="details-service-details">Details:<span id="details-service-details"></span></label>
                    <label for="details-service-cleaner">Cleaner:<span id="details-service-cleaner"></span></label>
                   
                </form>
                </div>
            </div>


            <!-- Modal for Booking -->
            <div id="bookingModal" class="modal">
            <div class="modal-content">
                <h2>Confirm Booking</h2>
                <p id="modalDetails"></p>
                <button id="confirmBookingBtn" class="confirm-btn">Confirm Booking</button>
                <button id="cancelBookingBtn" class="cancel-btn">Cancel</button>
            </div>
            </div>
        </main>

        <script type="module">
            import { hmViewAllCSController } from './js/hmViewAllCSController.js';
            import { cleanerViewCountController } from './js/cleanerViewCountController.js';
            import { hmSearchAllCSController } from './js/hmSearchAllCSController.js';
            import { hmViewBookListingController } from './js/hmViewBookListingController.js';

            class HomeOwnerAllCSPage{

                async getAllServices(){
                    const controller = new hmViewAllCSController();
                    return await controller.fetchAllCleaningServices();
                }

                displayServices(services){
                    servicesContainer.innerHTML = "";

                    if (services.length === 0) {
                        servicesContainer.innerHTML = `<p>No listings found.</p>`;
                        return;
                    }

                    const grouped = {};
                    services.forEach(service => {
                        const category = service.serviceCategory || "Uncategorized";
                        if (!grouped[category]) grouped[category] = [];
                        grouped[category].push(service);
                    });

                    for (const [category, listings] of Object.entries(grouped)) {
                        const categorySection = document.createElement("div");
                        categorySection.classList.add("category-section");

                        const title = document.createElement("h2");
                        title.style.fontSize = "30px";
                        title.style.textDecoration = "underline";
                        title.textContent = category;
                        categorySection.appendChild(title);

                        listings.forEach(service => {
                            const serviceDiv = document.createElement("div");
                            serviceDiv.classList.add("service-item");
                            serviceDiv.innerHTML = `
                            <p><strong>Category:</strong> ${service.serviceCategory}</p>
                            <p><strong>Service:</strong> ${service.listingName}</p>
                            <p><strong>Created By:</strong> ${service.createdBy || "Unknown"}</p>
                            <button class="details-btn" data-id="${service.id}">Details</button>
                            <button class="book-btn" data-id="${service.id}">Book Now</button>
                            <button class="fav-btn" data-id="${service.id}">Add to Favourites</button>
                            `;
                            categorySection.appendChild(serviceDiv);
                        });

                    servicesContainer.appendChild(categorySection);
                    }
                }
            }



            // Load services immediately on page load
            window.addEventListener("DOMContentLoaded", async () => {
                const page = new HomeOwnerAllCSPage();
                const services = await page.getAllServices();
                page.displayServices(services);

                // Modal Setup
                const detailsModal = document.getElementById("detailsModal");
                const closeDetails = document.getElementById("closeModalBtn-details");

                // booking confirmation
                const bookingModal = document.getElementById("bookingModal");
                const cancelBookingBtn = document.getElementById("cancelBookingBtn");
                const confirmBookingBtn = document.getElementById("confirmBookingBtn");



                // Close modal
                closeDetails.addEventListener("click", () => detailsModal.style.display = "none");
                cancelBookingBtn.addEventListener("click", () => bookingModal.style.display = "none");

                document.getElementById("servicesContainer").addEventListener("click", async (e) => {

                    if (e.target.classList.contains("details-btn")) {
                        const listingId = e.target.dataset.id;

                        const services = await page.getAllServices();
                        const selected = services.find(serv => serv.id === listingId);

                        if(selected){
                            document.getElementById("details-service-category").textContent = selected.serviceCategory;
                            document.getElementById("details-service-name").textContent = selected.listingName;
                            document.getElementById("details-service-fee").textContent = selected.fee;
                            document.getElementById("details-service-frequency").textContent = selected.listingFrequency;
                            document.getElementById("details-service-details").textContent = selected.details;
                            document.getElementById("details-service-cleaner").textContent = selected.createdBy;

                            detailsModal.style.display = "block";
                            const countData = {
                                category : selected.serviceCategory,
                                listingName : selected.listingName,
                                cleaner :selected.createdBy

                            }
                            const countviewController = new cleanerViewCountController();
                            await countviewController.addCountView(countData);
                        }

                    }

                 
                });

                document.getElementById("searchBtn").addEventListener("click", async () => {
                    const category = document.getElementById("categoryFilter").value;
                    const status = document.getElementById("statusFilter").value;
                    const price = document.getElementById("priceFilter").value;
                    const controller = new hmSearchAllCSController();

                    const filters = { category, status, price };
                    const allServices = await controller.fetchCleaningServices(filters);
                    page.displayServices(allServices);
                });

                function showBookingModal(service) {
                    selectedService = service;
                    document.getElementById("modalDetails").textContent =
                    `You are about to book the service: ${service.listingName} for ${service.serviceCategory}. Price: $${service.fee}`;
                    bookingModal.style.display = "block";
                }

                document.getElementById("servicesContainer").addEventListener("click", async (e) => {

                    if (e.target.classList.contains("book-btn")) {
                        const listingId = e.target.dataset.id;
                        const services = await page.getAllServices();
                        const selected = services.find(serv => serv.id === listingId);

                        if(selected){
                            document.getElementById("modalDetails").textContent =
                            `You are about to book the service: ${selected.listingName} for ${selected.serviceCategory}. Price: $${selected.fee}`;

                            bookingModal.style.display = "block";
                        }

                        confirmBookingBtn.addEventListener("click", async () => {
                            const bookingData = {
                                listingName: selected.listingName,
                                categoryName: selected.serviceCategory,
                                price: selected.fee,
                                cleanerEmail: selected.createdBy,
                                serviceId: selected.id
                            };

                            try {
                                const userEmail = localStorage.getItem("loggedInUserEmail");
                                console.log(userEmail);
                                const bookController = new hmViewBookListingController();
                                await bookController.createBooking(selected.id, selected.createdBy, userEmail, bookingData);
                                alert(`Booking confirmed for: ${selected.listingName}`);
                                bookingModal.style.display = "none";
                                // window.location.href = "HMViewBKHistory.html";
                            } catch (err) {
                                console.error("Booking failed:", err);
                                alert("Booking failed. Please try again.");
                            }
                        });

                    }
      
                });






            });




        </script>
    </body>
</html>