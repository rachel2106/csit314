<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>User Admin Dashboard</title>
    <link rel="stylesheet" href="css/style.css" />
</head>
<body class="useradmin-page">
    <div class="userAdminHeaderBanner">
        <a href="userAdminPage.html">
            <img src="C2Ccleaningservicelogo.png" alt="logo" class="logo-img" />
        </a>
        <a href="userAdminViewAccs.html" id="adminViewAccs">View Users Accounts</a>
        <a href="userAdminPageProfiles.html" id="adminProfilePage">View Profiles</a>
        <a href="loginPage.html" class="logoutBtn" id="logout">Logout</a>
    </div>

    <main>
        <div class="useradmin-viewAccs">Welcome to User Admin page</div>

        <div class="userAdmin-viewContainer" id="admin-viewContainer">
            <div class="useradmin-viewContainerHeader">
                <h2 class="viewUserAcc">View User Accounts:</h2>
                <input type="text" id="search-id" placeholder="Email" />
                <button class="adminBtn" id="admin-search-button">Search</button>
                <a href="userAdminCreateAcc.html" class="adminCreateBtn" id="admin-create-button">Create Account</a>
            </div>

            <div class="admin-viewtable" id="adminView">
                <table id="admin-table">
                    <thead id="admin-tableheader">
                        <tr id="admin-rowheader">
                            <th>UserType:</th>
                            <th>First Name:</th>
                            <th>Last Name:</th>
                            <th>Email:</th>
                            <th>Status (Active/Deleted/Suspended):</th>
                            <th>Options:</th>
                        </tr>
                    </thead>
                    <tbody id="data-table"></tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Modal for updating user account -->
    <div id="updateModal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h3>Update User Account</h3>
            <form id="update-form">
                <label for="first-name">First Name:</label>
                <input type="text" id="first-name" name="first-name" required />

                <label for="last-name">Last Name:</label>
                <input type="text" id="last-name" name="last-name" required />

                <label for="email">Email:</label>
                <input type="email" id="email" name="email" required />

                <label for="password">Password (leave blank if no change):</label>
                <input type="password" id="password" name="password" />

                <button type="submit" class="update-btn">Update Account</button>
            </form>
        </div>
    </div>

    <!-- Logout button functionality -->
    <script>
        document.getElementById("logout").addEventListener("click", function () {
            window.location.href = "loginPage.html";
        });
    </script>

    <!-- Load Controller and Render Users -->
    <script type="module">
        import { userAdminViewAllAccController } from './js/userAdminViewAllAccController.js';

        class AdminPage {
            async getUserList() {
                const controller = new userAdminViewAllAccController();
                return await controller.getUserList();
            }

            displayUserList(userList) {
                const table = document.getElementById("data-table");
                table.innerHTML = "";
                userList.sort((a, b) => a.userType.localeCompare(b.userType));

                let lastType = "";

                userList.forEach((userData) => {
                    if (userData.userType !== lastType) {
                        const groupRow = document.createElement("tr");
                        groupRow.innerHTML = `
                            <td colspan="6" style="font-weight: bold; background-color: #d8bba0;">
                                ${userData.userType.toUpperCase()}
                            </td>`;
                        table.appendChild(groupRow);
                        lastType = userData.userType;
                    }

                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td>${userData.userType}</td>
                        <td>${userData.firstName}</td>
                        <td>${userData.lastName}</td>
                        <td><a href="userDetails.html?email=${userData.email}">${userData.email}</a></td>
                        <td>${userData.status}</td>
                        <td>
                            <button class="update-account-icon" value="${userData.email}">Update</button>
                            <button class="delete-account-icon" value="${userData.email}">Delete</button>
                            <button class="suspend-account-icon" value="${userData.email}">Suspend</button>
                        </td>`;
                    table.appendChild(row);
                });
            }
        }

        window.addEventListener("DOMContentLoaded", async () => {
            const admin = new AdminPage();
            const users = await admin.getUserList();
            admin.displayUserList(users);
        });
    </script>

    <!-- Modal Logic & Update Form -->
    <script type="module">
        import { userAdminUpdateAccController } from "./js/userAdminUpdateAccController.js";
        import { userAdminViewAllAccController } from './js/userAdminViewAllAccController.js';

        const modal = document.getElementById("updateModal");
        const closeModal = document.querySelector(".close-btn");
        const updateForm = document.getElementById("update-form");

        document.getElementById("data-table").addEventListener("click", async (e) => {
            if (e.target.classList.contains("update-account-icon")) {
                const userEmail = e.target.value;
                modal.style.display = "block";

                const userData = await fetchUserData(userEmail);
                document.getElementById("first-name").value = userData.firstName;
                document.getElementById("last-name").value = userData.lastName;
                document.getElementById("email").value = userData.email;

                updateForm.dataset.originalEmail = userEmail;
            }
        });

        closeModal.addEventListener("click", () => {
            modal.style.display = "none";
        });

        window.addEventListener("click", (e) => {
            if (e.target === modal) {
                modal.style.display = "none";
            }
        });

        updateForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const originalEmail = updateForm.dataset.originalEmail;
            const firstName = document.getElementById("first-name").value;
            const lastName = document.getElementById("last-name").value;
            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;

            const controller = new userAdminUpdateAccController();
            try {
                await controller.updateUserAccount({
                    originalEmail,
                    firstName,
                    lastName,
                    newEmail: email,
                    password
                });
                alert("User account updated!");
                modal.style.display = "none";
                location.reload();
            } catch (err) {
                alert("Error updating user: " + err.message);
            }
        });

        async function fetchUserData(userEmail) {
            const controller = new userAdminViewAllAccController();
            const userList = await controller.getUserList();
            return userList.find(user => user.email === userEmail);
        }
    </script>

<script type="module">
    import { userAdminSearchUserController } from './js/userAdminSearchUserController.js';

    // Attach event listener to the Search button
    document.getElementById("admin-search-button").addEventListener("click", async () => {
        // Get the email entered in the input box
        const searchEmail = document.getElementById("search-id").value.trim().toLowerCase();

        // Check if the email input is empty
        if (!searchEmail) {
            alert("Please enter an email to search.");
            return;
        }

        // Create an instance of the controller to perform the search
        const searchController = new userAdminSearchUserController();

        try {
            // Get search result from Firestore
            const userData = await searchController.searchUser(searchEmail);

            // Clear previous search results
            const table = document.getElementById("data-table");
            table.innerHTML = "";

            if (userData) {
                // If user is found, display user data
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${userData.userType}</td>
                    <td>${userData.firstName}</td>
                    <td>${userData.lastName}</td>
                    <td><a href="userDetails.html?email=${userData.email}">${userData.email}</a></td>
                    <td>${userData.status}</td>
                    <td>
                        <button class="update-account-icon" value="${userData.email}">Update</button>
                        <button class="delete-account-icon" value="${userData.email}">Delete</button>
                        <button class="suspend-account-icon" value="${userData.email}">Suspend</button>
                    </td>`;
                table.appendChild(row);
            } else {
                // If no user is found, display "No user found" message
                const noResultRow = document.createElement("tr");
                noResultRow.innerHTML = `<td colspan="6" style="text-align: center;">No user found with that email.</td>`;
                table.appendChild(noResultRow);
            }
        } catch (error) {
            console.error("Error searching for user:", error);
            alert("Error searching for user. Please try again.");
        }
    });
</script>




</body>
</html>
