<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>User Admin Dashboard</title>
    <link rel="stylesheet" href="css/style.css" />
</head>
<body class="useradmin-page">
    <div class="userAdminHeaderBanner">
        <a href="userAdminPage.html">
            <img src="C2Ccleaningservicelogo.png" alt="logo" class="logo-img" />
        </a>
        <a href="userAdminViewAccs.html" id="adminViewAccs">View Users Accounts</a>
        <a href="userAdminPageProfiles.html" id="adminProfilePage">View Profiles</a>
        <a href="loginPage.html" class="logoutBtn" id="logout">Logout</a>
    </div>

    <main>
        <div class="useradmin-viewAccs">Welcome to User Admin page</div>

        <div class="userAdmin-viewContainer" id="admin-viewContainer">
            <div class="useradmin-viewContainerHeader">
                <h2 class="viewUserAcc">View User Accounts:</h2>
                <input type="text" id="search-id" placeholder="Email" />
                <button class="adminBtn" id="admin-search-button">Search</button>
                <button class="adminBtn" id="admin-reset-button">Reset</button>
                <a href="userAdminCreateAcc.html" class="adminCreateBtn" id="admin-create-button">Create Account</a>
            </div>

            <div class="admin-viewtable" id="adminView">
                <table id="admin-table">
                    <thead id="admin-tableheader">
                        <tr id="admin-rowheader">
                            <th>UserType:</th>
                            <th>First Name:</th>
                            <th>Last Name:</th>
                            <th>Email:</th>
                            <th>Status (Active/Deleted/Suspended):</th>
                            <th>Options:</th>
                        </tr>
                    </thead>
                    <tbody id="data-table"></tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Modal for updating user account -->
    <div id="updateModal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h3>Update User Account</h3>
            <form id="update-form">
                <label for="first-name">First Name:</label>
                <input type="text" id="first-name" name="first-name" required />

                <label for="last-name">Last Name:</label>
                <input type="text" id="last-name" name="last-name" required />

                <label for="email">Email:</label>
                <input type="email" id="email" name="email" required />

                <label for="password">Password (leave blank if no change):</label>
                <input type="password" id="password" name="password" />

                <button type="submit" class="update-btn">Update Account</button>
            </form>
        </div>
    </div>

    <!-- Logout button functionality -->
    <script>
        document.getElementById("logout").addEventListener("click", function () {
            window.location.href = "loginPage.html";
        });
    </script>

    <!-- Load Controller and Render Users -->
    <script type="module">
        import { userAdminViewAllAccController } from './js/userAdminViewAllAccController.js';

        class AdminPage {
            async getUserList() {
                const controller = new userAdminViewAllAccController();
                return await controller.getUserList();
            }

            displayUserList(userList) {
                const table = document.getElementById("data-table");
                table.innerHTML = "";
                userList.sort((a, b) => a.userType.localeCompare(b.userType));

                let lastType = "";

                userList.forEach((userData) => {
                    if (userData.userType !== lastType) {
                        const groupRow = document.createElement("tr");
                        groupRow.innerHTML = `
                            <td colspan="6" style="font-weight: bold; background-color: #d8bba0;">
                                ${userData.userType.toUpperCase()}
                            </td>`;
                        table.appendChild(groupRow);
                        lastType = userData.userType;
                    }

                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td>${userData.userType}</td>
                        <td>${userData.firstName}</td>
                        <td>${userData.lastName}</td>
                        <td><a href="userDetails.html?email=${userData.email}">${userData.email}</a></td>
                        <td>${userData.status}</td>
                        <td>
                            <button class="update-account-icon" value="${userData.email}">Update</button>
                            <button class="delete-account-icon" value="${userData.email}">Delete</button>
                            <button class="suspend-account-icon" value="${userData.email}">Suspend</button>
                        </td>`;
                    table.appendChild(row);
                });
            }
        }

        window.addEventListener("DOMContentLoaded", async () => {
            const admin = new AdminPage();
            const users = await admin.getUserList();
            admin.displayUserList(users);
        });
    </script>

    <!-- Modal Logic & Update Form -->
    <script type="module">
        import { userAdminUpdateAccController } from "./js/userAdminUpdateAccController.js";
        import { userAdminViewAllAccController } from './js/userAdminViewAllAccController.js';

        const modal = document.getElementById("updateModal");
        const closeModal = document.querySelector(".close-btn");
        const updateForm = document.getElementById("update-form");

        document.getElementById("data-table").addEventListener("click", async (e) => {
            if (e.target.classList.contains("update-account-icon")) {
                const userEmail = e.target.value;
                modal.style.display = "block";

                const userData = await fetchUserData(userEmail);
                document.getElementById("first-name").value = userData.firstName;
                document.getElementById("last-name").value = userData.lastName;
                document.getElementById("email").value = userData.email;

                updateForm.dataset.originalEmail = userEmail;
            }
        });

        closeModal.addEventListener("click", () => {
            modal.style.display = "none";
        });

        window.addEventListener("click", (e) => {
            if (e.target === modal) {
                modal.style.display = "none";
            }
        });

        updateForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const originalEmail = updateForm.dataset.originalEmail;
            const firstName = document.getElementById("first-name").value;
            const lastName = document.getElementById("last-name").value;
            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;

            const controller = new userAdminUpdateAccController();
            try {
                await controller.updateUserAccount({
                    originalEmail,
                    firstName,
                    lastName,
                    newEmail: email,
                    password
                });
                alert("User account updated!");
                modal.style.display = "none";
                location.reload();
            } catch (err) {
                alert("Error updating user: " + err.message);
            }
        });

        async function fetchUserData(userEmail) {
            const controller = new userAdminViewAllAccController();
            const userList = await controller.getUserList();
            return userList.find(user => user.email === userEmail);
        }
    </script>

    <script type="module">

import { userAdminSearchUserController } from "./js/userAdminSearchUserController.js";
import { userAdminViewAllAccController } from './js/userAdminViewAllAccController.js';

document.addEventListener('DOMContentLoaded', () => {
    const searchBtn = document.getElementById('admin-search-button');
    const resetBtn = document.getElementById('admin-reset-button');
    const searchInput = document.getElementById('search-id');
    const table = document.getElementById('data-table');

    const controller = new userAdminSearchUserController();

    searchBtn.addEventListener('click', async () => {
        const email = searchInput.value.trim().toLowerCase();
        table.innerHTML = ""; // Clear previous table rows

        if (!email) {
            table.innerHTML = `<tr><td colspan="6">Please enter an email to search.</td></tr>`;
            return;
        }

        table.innerHTML = `<tr><td colspan="6">Searching...</td></tr>`;

        try {
            const user = await controller.searchUser(email);
            console.log("User object:", user); // Debugging log

            if (user) {
                const row = `
                    <tr><td colspan="6" style="font-weight: bold; background-color: #d8bba0;">
                        ${user?.userType ? user.userType.toUpperCase() : "Unknown Type"}
                    </td></tr>
                    <tr>
                        <td>${user.userType ?? "Unknown"}</td>
                        <td>${user.firstName ?? "Unknown"}</td>
                        <td>${user.lastName ?? "Unknown"}</td>
                        <td><a href="userDetails.html?email=${user.email}">${user.email ?? "No Email"}</a></td>
                        <td>${user.userStatus ?? "Unknown"}</td>
                        <td>
                            <button class="update-account-icon" value="${user.email}">Update</button>
                            <button class="delete-account-icon" value="${user.email}">Delete</button>
                            <button class="suspend-account-icon" value="${user.email}">Suspend</button>
                        </td>
                    </tr>`;
                table.innerHTML = row;
            } else {
                table.innerHTML = `<tr><td colspan="6">No user found with that email.</td></tr>`;
            }
        } catch (error) {
            console.error("Search error:", error);
            table.innerHTML = `<tr><td colspan="6">An error occurred while searching.</td></tr>`;
        }
    });

    resetBtn.addEventListener('click', async () => {
        searchInput.value = "";
        const viewController = new userAdminViewAllAccController();
        const allUsers = await viewController.getUserList();

        table.innerHTML = "";
        allUsers.sort((a, b) => a.userType.localeCompare(b.userType));

        let lastType = "";
        allUsers.forEach(user => {
            if (user.userType !== lastType) {
                table.innerHTML += `<tr><td colspan="6" style="font-weight: bold; background-color: #d8bba0;">
                    ${user.userType.toUpperCase()}</td></tr>`;
                lastType = user.userType;
            }

            table.innerHTML += `
                <tr>
                    <td>${user.userType}</td>
                    <td>${user.firstName}</td>
                    <td>${user.lastName}</td>
                    <td><a href="userDetails.html?email=${user.email}">${user.email}</a></td>
                    <td>${user.userStatus}</td>
                    <td>
                        <button class="update-account-icon" value="${user.email}">Update</button>
                        <button class="delete-account-icon" value="${user.email}">Delete</button>
                        <button class="suspend-account-icon" value="${user.email}">Suspend</button>
                    </td>
                </tr>`;
        });
    });
});

  </script>




</body>
</html>
