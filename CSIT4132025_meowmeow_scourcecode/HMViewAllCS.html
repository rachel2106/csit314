<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Homeowners All Cleaning Services</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body class="homeowners-page">
  <div class="homeownersHeaderBanner">
    <a href="homeownersPage.html">
      <img src="C2Ccleaningservicelogo.png" alt="logo" class="logo-img"/>
    </a>
    <a href="HMViewAllCS.html" class="services-menu">All Cleaning Services</a>
    <a href="HMViewBKHistory.html" class="services-menu">Booking History</a>
    <a href="HMFavourites.html" class="services-menu">Favourites</a>
    <a href="loginPage.html" class="logoutBtn" id="logout">Logout</a>
  </div>

  <main>
    <div class="view-CS">
      <div class="CS">
        <!-- Filters -->
        <select id="categoryFilter">
          <option value="">All Categories</option>
          <option value="Deep Cleaning">Deep Cleaning</option>
          <option value="General House Cleaning">General House Cleaning</option>
          <option value="Move In or Out Cleaning">Move In or Out Cleaning</option>
          <option value="Office & Commercial Cleaning">Office & Commercial Cleaning</option>
          <option value="Pet-Friendly Cleaning">Pet-Friendly Cleaning</option>
          <option value="Post-Construction Cleaning">Post-Construction Cleaning</option>
          <option value="Specialized Cleaning">Specialized Cleaning</option>
        </select>

        <select id="statusFilter">
          <option value="">All Status</option>
          <option value="available">Available</option>
          <option value="unavailable">Unavailable</option>
        </select>

        <select id="priceFilter">
          <option value="">All Prices</option>
          <option value="0-50">$0 - $50</option>
          <option value="51-100">$51 - $100</option>
          <option value="101-200">$101 - $200</option>
          <option value="201-500">$201 - $500</option>
        </select>

        <button id="searchBtn">Search</button>
        <p id="errorContainer"></p>
      </div>
    </div>

    <div id="servicesContainer" class="services-container"></div>
  </main>

  <script type="module">
    import { HMViewAllCSController } from './js/HMViewAllCSController.js';
    import { HMSearchAllCSController } from './js/HMSearchAllCSController.js';

    const controller = new HMViewAllCSController();
    const searchController = new HMSearchAllCSController();

    const categoryFilter = document.getElementById("categoryFilter");
    const priceFilter = document.getElementById("priceFilter");
    const statusFilter = document.getElementById("statusFilter");
    const searchBtn = document.getElementById("searchBtn");
    const servicesContainer = document.getElementById("servicesContainer");
    const errorContainer = document.getElementById("errorContainer");

    function displayError(message) {
      errorContainer.textContent = message;
      errorContainer.style.color = "red";
    }

    function clearError() {
      errorContainer.textContent = "";
    }

    function displayServices(services) {
      servicesContainer.innerHTML = "";

      if (!services || services.length === 0) {
        servicesContainer.innerHTML = "<p>No cleaning services found.</p>";
        return;
      }

      const categories = {};

      services.forEach(service => {
        const category = service.serviceCategory || "Uncategorized";
        if (!categories[category]) {
          categories[category] = [];
        }
        categories[category].push(service);
      });

      Object.keys(categories).forEach(category => {
        const categoryDiv = document.createElement("div");
        categoryDiv.classList.add("category-section");

        const categoryHeader = document.createElement("h2");
        categoryHeader.textContent = category;
        categoryDiv.appendChild(categoryHeader);

        const serviceList = document.createElement("ul");
        serviceList.classList.add("service-list");

        categories[category].forEach(service => {
          const listItem = document.createElement("li");
          listItem.classList.add("service-item");
          listItem.innerHTML = `
            <p><strong>Category:</strong> ${service.serviceCategory || "N/A"}</p>
            <div class="divider"></div>
            <p><strong>Status:</strong> ${service.listStatus || "N/A"}</p>
            <div class="divider"></div>
            <p><strong>Price:</strong> $${service.fee || 0}</p>
            <div class="divider"></div>
            <p><strong>View Count:</strong> ${service.viewCount || 0}</p>
            <div class="divider"></div>
            <p><strong>Shortlisted:</strong> ${service.viewShortlisted || 0}</p>
            <div class="divider"></div>
            <p><strong>Created By:</strong> ${service.createdBy || "Unknown"}</p>
            <button class="book-btn" data-id="${service.id}">Book Now</button>
            <button class="fav-btn" data-id="${service.id}" data-category="${service.serviceCategory}">Add to Favourites</button>
          `;
          serviceList.appendChild(listItem);
        });

        categoryDiv.appendChild(serviceList);
        servicesContainer.appendChild(categoryDiv);
      });

      // Add "Add to Favourites" event listeners
      document.querySelectorAll(".fav-btn").forEach(button => {
        button.addEventListener("click", async (e) => {
          const serviceId = e.target.dataset.id;
          const serviceCategory = e.target.dataset.category;
          try {
            await searchController.incrementShortlistCount(serviceCategory, serviceId);
            alert("Added to favourites!");
          } catch (error) {
            console.error("Failed to update shortlist count:", error);
          }
        });
      });
    }

    async function applyFilters() {
      clearError();
      try {
        const filters = {
          category: categoryFilter.value,
          price: priceFilter.value,
          status: statusFilter.value
        };

        const services = await searchController.getFilteredServices(filters);
        displayServices(services);
      } catch (err) {
        console.error("Filter error:", err);
        displayError("Failed to load services. Please try again.");
      }
    }

    searchBtn.addEventListener("click", applyFilters);

    window.addEventListener("DOMContentLoaded", async () => {
      clearError();
      try {
        const filters = {
          category: '',
          price: '',
          status: ''
        };

        const services = await searchController.getFilteredServices(filters);
        displayServices(services);
      } catch (err) {
        console.error("Initial load error:", err);
        displayError("Failed to load services. Please check your connection.");
      }
    });

    document.getElementById("logout").addEventListener("click", () => {
      window.location.href = "loginPage.html";
    });
  </script>
</body>
</html>
