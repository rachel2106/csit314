<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Homeowners All Cleaning Services</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body class="homeowners-page">
  <div class="homeownersHeaderBanner">
    <a href="homeownersPage.html">
      <img src="C2Ccleaningservicelogo.png" alt="logo" class="logo-img"/>
    </a>
    <a href="HMViewAllCS.html" class="services-menu">All Cleaning Services</a>
    <a href="HMViewBKHistory.html" class="services-menu">Booking History</a>
    <a href="HMFavourites.html" class="services-menu">Favourites</a>
    <a href="loginPage.html" class="logoutBtn" id="logout">Logout</a>
  </div>

  <main>
    <div class="view-CS">
      <div class="CS">
        <!-- Filters -->
        <select id="categoryFilter">
          <option value="">All Categories</option>
          <option value="Deep Cleaning">Deep Cleaning</option>
          <option value="General House Cleaning">General House Cleaning</option>
          <option value="Move In or Out Cleaning">Move In or Out Cleaning</option>
          <option value="Office & Commercial Cleaning">Office & Commercial Cleaning</option>
          <option value="Pet-Friendly Cleaning">Pet-Friendly Cleaning</option>
          <option value="Post-Construction Cleaning">Post-Construction Cleaning</option>
          <option value="Specialized Cleaning">Specialized Cleaning</option>
        </select>

        <select id="statusFilter">
          <option value="">All Status</option>
          <option value="available">Available</option>
          <option value="unavailable">Unavailable</option>
        </select>

        <select id="priceFilter">
          <option value="">All Prices</option>
          <option value="0-50">$0 - $50</option>
          <option value="51-100">$51 - $100</option>
          <option value="101-200">$101 - $200</option>
          <option value="201-500">$201 - $500</option>
        </select>

        <button id="searchBtn">Search</button>
      </div>
    </div>

    <div id="servicesContainer" class="services-container"></div>

    <!-- Modal for Booking -->
    <div id="bookingModal" class="modal">
      <div class="modal-content">
        <h2>Confirm Booking</h2>
        <p id="modalDetails"></p>
        <button id="confirmBookingBtn" class="confirm-btn">Confirm Booking</button>
        <button id="cancelBookingBtn" class="cancel-btn">Cancel</button>
      </div>
    </div>
  </main>

  <script type="module">
    import { HMViewAllCSController } from './js/HMViewAllCSController.js';

    const controller = new HMViewAllCSController();

    const servicesContainer = document.getElementById("servicesContainer");
    const modal = document.getElementById("bookingModal");
    const cancelBookingBtn = document.getElementById("cancelBookingBtn");
    const confirmBookingBtn = document.getElementById("confirmBookingBtn");

    let selectedService = {};

    // Show booking modal
    function showBookingModal(service) {
      selectedService = service;
      const serviceName = service.listingName || "Unnamed Service";
      const serviceCategory = service.serviceCategory || "Unspecified Category";
      const serviceFee = service.fee !== undefined ? `$${service.fee}` : "No Price";

      document.getElementById("modalDetails").textContent =
        `You are about to book the service: ${serviceName} for ${serviceCategory}. Price: ${serviceFee}`;

      modal.style.display = "block";
    }

    // Cancel the modal
    cancelBookingBtn.addEventListener("click", () => {
      modal.style.display = "none";
    }); 

    // Confirm booking (simplified version)
    confirmBookingBtn.addEventListener("click", async () => {
      const bookingData = {
        serviceId: selectedService.id,
        listingName: selectedService.listingName || "Unnamed Service",
        categoryName: selectedService.serviceCategory || "Unspecified Category",
      };

      // Just display the booking confirmation message (no extra checks)
      alert(`Booking confirmed for: ${selectedService.listingName}`);
      modal.style.display = "none"; // Close the modal
    });

    // Display the services in the container
    function displayServices(services) {
  servicesContainer.innerHTML = "";

  if (services.length === 0) {
    servicesContainer.innerHTML = `<p>No listings found.</p>`;
    return;
  }

  // Group services by category
  const grouped = {};
  services.forEach(service => {
    const category = service.serviceCategory || "Uncategorized";
    if (!grouped[category]) {
      grouped[category] = [];
    }
    grouped[category].push(service);
  });

  // For each category, create a section
  for (const [category, listings] of Object.entries(grouped)) {
    const categorySection = document.createElement("div");
    categorySection.classList.add("category-section");

    const title = document.createElement("h2");
    title.style.fontSize = "30px";
    title.style.textDecoration = "underline"
    title.textContent = category;
    categorySection.appendChild(title);

    listings.forEach(service => {
      const serviceDiv = document.createElement("div");
      serviceDiv.classList.add("service-item");
      serviceDiv.innerHTML = `
         <p><strong>Category:</strong> ${service.serviceCategory}</p>
          <p><strong>Price:</strong> $${service.fee}</p>
          <p><strong>Views:</strong> ${service.viewCount || 0}</p>
          <p><strong>Shortlisted:</strong> ${service.viewShortlisted || 0}</p>
          <p><strong>Created By:</strong> ${service.createdBy || "Unknown"}</p>
          <button class="book-btn" data-id="${service.id}">Book Now</button>
          <button class="fav-btn" data-id="${service.id}">Add to Favourites</button>
      `;
      categorySection.appendChild(serviceDiv);
    });

    servicesContainer.appendChild(categorySection);
  }

  // Add event listener for each 'Book Now' button
  document.querySelectorAll(".book-btn").forEach(button => {
    button.addEventListener("click", (e) => {
      const serviceId = e.target.dataset.id;
      const selected = services.find(service => service.id === serviceId);
      showBookingModal(selected);
    });
  });
}

    // Search button click handler
document.getElementById("searchBtn").addEventListener("click", async () => {
  const category = document.getElementById("categoryFilter").value;
  const status = document.getElementById("statusFilter").value;
  const price = document.getElementById("priceFilter").value;

  const filters = { category, status, price };

  const services = await controller.getFilteredCleaningServices(filters);
  displayServices(services);
});


    // Fetch all services on page load
    window.addEventListener("DOMContentLoaded", async () => {
      const services = await controller.fetchAllCleaningServices();
      displayServices(services);
    });

    document.querySelectorAll(".fav-btn").forEach(button => {
  button.addEventListener("click", async (e) => {
    const serviceId = e.target.dataset.id;
    const service = services.find(s => s.id === serviceId);
    if (!service) return;

    try {
      await controller.addToFavourites(service);
      alert("Added to favourites!");
    } catch (err) {
      console.error("Failed to add to favourites:", err);
      alert("Failed to add to favourites.");
    }
  });
});
  </script>
</body>
</html>
