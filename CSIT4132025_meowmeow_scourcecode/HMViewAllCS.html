<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Homeowners All Cleaning Services</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body class="homeowners-page">
  <div class="homeownersHeaderBanner">
    <a href="homeownersPage.html">
      <img src="C2Ccleaningservicelogo.png" alt="logo" class="logo-img"/>
    </a>
    <a href="HMViewAllCS.html" class="services-menu">All Cleaning Services</a>
    <a href="HMViewBKHistory.html" class="services-menu">Booking History</a>
    <a href="HMShortlisted.html" class="services-menu">Favourites</a>
    <a href="loginPage.html" class="logoutBtn" id="logout">Logout</a>
  </div>

  <main>
    <div class="view-CS">
      <div class="CS">
        <select id="categoryFilter">
          <option value="">All Categories</option>
          <option value="Deep Cleaning">Deep Cleaning</option>
          <option value="General House Cleaning">General House Cleaning</option>
          <option value="Move In or Out Cleaning">Move In or Out Cleaning</option>
          <option value="Office & Commercial Cleaning">Office & Commercial Cleaning</option>
          <option value="Pet-Friendly Cleaning">Pet-Friendly Cleaning</option>
          <option value="Post-Construction Cleaning">Post-Construction Cleaning</option>
          <option value="Specialized Cleaning">Specialized Cleaning</option>
        </select>

        <select id="statusFilter">
          <option value="">All Status</option>
          <option value="available">Available</option>
          <option value="unavailable">Unavailable</option>
        </select>

        <select id="priceFilter">
          <option value="">All Prices</option>
          <option value="0-50">$0 - $50</option>
          <option value="51-100">$51 - $100</option>
          <option value="101-200">$101 - $200</option>
          <option value="201-500">$201 - $500</option>
        </select>

        <button id="searchBtn">Search</button>
      </div>
    </div>

    <div id="servicesContainer" class="services-container"></div>

    <!-- Modal for Booking -->
    <div id="bookingModal" class="modal">
      <div class="modal-content">
        <h2>Confirm Booking</h2>
        <p id="modalDetails"></p>
        <button id="confirmBookingBtn" class="confirm-btn">Confirm Booking</button>
        <button id="cancelBookingBtn" class="cancel-btn">Cancel</button>
      </div>
    </div>
  </main>
<script type="module">
  import { HMViewAllCSController } from './js/HMViewAllCSController.js';

  const controller = new HMViewAllCSController();
  const servicesContainer = document.getElementById("servicesContainer");
  const modal = document.getElementById("bookingModal");
  const cancelBookingBtn = document.getElementById("cancelBookingBtn");
  const confirmBookingBtn = document.getElementById("confirmBookingBtn");

  let selectedService = {};

  // Load services immediately on page load
  window.addEventListener("DOMContentLoaded", async () => {
    const services = await controller.fetchAllCleaningServices();
    displayServices(services);
  });

  document.getElementById("searchBtn").addEventListener("click", async () => {
    const category = document.getElementById("categoryFilter").value;
    const status = document.getElementById("statusFilter").value;
    const price = document.getElementById("priceFilter").value;

    const filters = { category, status, price };
    const services = await controller.getFilteredCleaningServices(filters);
    displayServices(services);
  });

  cancelBookingBtn.addEventListener("click", () => {
    modal.style.display = "none";
  });

  confirmBookingBtn.addEventListener("click", async () => {
    const bookingData = {
      listingName: selectedService.listingName,
      categoryName: selectedService.serviceCategory,
      price: selectedService.fee,
      cleanerEmail: selectedService.createdBy,
      serviceId: selectedService.id
    };

    try {
      await controller.createBooking(selectedService.id, selectedService.createdBy, bookingData);
      alert(`Booking confirmed for: ${selectedService.listingName}`);
      modal.style.display = "none";
      window.location.href = "HMViewBKHistory.html";
    } catch (err) {
      console.error("Booking failed:", err);
      alert("Booking failed. Please try again.");
    }
  });

  function showBookingModal(service) {
    selectedService = service;
    document.getElementById("modalDetails").textContent =
      `You are about to book the service: ${service.listingName} for ${service.serviceCategory}. Price: $${service.fee}`;
    modal.style.display = "block";
  }

  function displayServices(services) {
    servicesContainer.innerHTML = "";

    if (services.length === 0) {
      servicesContainer.innerHTML = `<p>No listings found.</p>`;
      return;
    }

    const grouped = {};
    services.forEach(service => {
      const category = service.serviceCategory || "Uncategorized";
      if (!grouped[category]) grouped[category] = [];
      grouped[category].push(service);
    });

    for (const [category, listings] of Object.entries(grouped)) {
      const categorySection = document.createElement("div");
      categorySection.classList.add("category-section");

      const title = document.createElement("h2");
      title.style.fontSize = "30px";
      title.style.textDecoration = "underline";
      title.textContent = category;
      categorySection.appendChild(title);

      listings.forEach(service => {
        const serviceDiv = document.createElement("div");
        serviceDiv.classList.add("service-item");
        serviceDiv.innerHTML = `
          <p><strong>Category:</strong> ${service.serviceCategory}</p>
          <p><strong>Price:</strong> $${service.fee}</p>
          <p><strong>Views:</strong> ${service.viewCount || 0}</p>
          <p><strong>Shortlisted:</strong> ${service.viewShortlisted || 0}</p>
          <p><strong>Created By:</strong> ${service.createdBy || "Unknown"}</p>
          <button class="book-btn" data-id="${service.id}">Book Now</button>
          <button class="fav-btn" data-id="${service.id}">Add to Favourites</button>
        `;
        categorySection.appendChild(serviceDiv);
      });

      servicesContainer.appendChild(categorySection);
    }

    // Book Now button handlers
    document.querySelectorAll(".book-btn").forEach(button => {
      button.addEventListener("click", (e) => {
        const serviceId = e.target.dataset.id;
        const selected = services.find(service => service.id === serviceId);
        showBookingModal(selected);
      });
    });

    // Add to Favourites button handlers
    document.querySelectorAll(".fav-btn").forEach(button => {
      button.addEventListener("click", async (e) => {
        const serviceId = e.target.dataset.id;
        const service = services.find(s => s.id === serviceId);

        // Get the logged-in user email directly from localStorage here for safety
        const userEmail = localStorage.getItem("loggedInUserEmail");
        if (!userEmail) {
          alert("You must be logged in to add to favourites.");
          return;
        }

        // Prepare data object to send to Firestore
        const favData = {
          listingName: service.listingName,
          serviceCategory: service.serviceCategory,
          fee: service.fee,
          createdBy: service.createdBy,
          serviceId: service.id,
          userEmail: userEmail  // include userEmail as a field, NOT the entire data
        };

        try {
          await controller.addToFavourites(favData);
          alert(`Added to Favourites: ${favData.listingName}`);
        } catch (err) {
          console.error("Add to favourites failed:", err);
          alert("Failed to add to favourites.");
        }
      });
    });
  }
</script>

</body>
</html>
