<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>User Admin Dashboard</title>
    <link rel="stylesheet" href="css/style.css" />
</head>
<body class="useradmin-page">
    <div class="userAdminHeaderBanner">
        <a href="userAdminPage.html">
            <img src="C2Ccleaningservicelogo.png" alt="logo" class="logo-img" />
        </a>
        <a href="userAdminViewAccs.html" id="adminViewAccs">View Users Accounts</a>
        <a href="userAdminPageProfiles.html" id="adminProfilePage">View Profiles</a>
        <a href="loginPage.html" class="logoutBtn" id="logout">Logout</a>
    </div>

    <main>
        <div class="useradmin-viewAccs">
            Welcome to User Admin Profile page
        </div> 

        <div class="userAdmin-viewContainer" id="admin-viewContiner">
            <div class="useradmin-viewContainerHeader">
                <h2 class="viewUserAcc">View User Profiles:</h2>
                <a href="userAdminCreateProfile.html" class="adminCreateProfileBtn" id="admin-create-profile">Create Profile</a>
            </div>

            <div class="admin-viewtable" id="adminView">
                <table id="admin-table">
                    <thead id="admin-tableheader">
                        <tr id="admin-rowheader">
                            <th>Profile:</th>
                            <th>Status:</th>
                            <th>Options:</th>
                        </tr>
                    </thead>
                    <tbody id="data-table"></tbody>
                </table>
            </div>
        </div>

        <!-- Profile details container where details will be shown after clicking "Search Profile" -->
        <div class="profile-details" id="profile-details-container">
            <!-- Profile details will be displayed here -->
        </div>
    </main>

    <!-- Logout button function -->
    <script>
        document.getElementById("logout").addEventListener("click", function () {
            console.log("Logout link has been clicked");
            window.location.href = "loginPage.html";
        });
    </script>

    <script type="module">
        import { userAdminAllProfilesController } from "./js/userAdminAllProfilesController.js";
        import { profileEntity } from "./js/profileEntity.js";

        class AdminProfilePage {
            constructor(){
            this.controller = new userAdminAllProfilesController();
            }

            // Helper function to extract a number from lastName
                extractNumberFromLastName(lastName) {
                    const match = lastName.match(/\d+/);
                    return match ? parseInt(match[0], 10) : 0;  // Default to 0 if no number found
            }

            // Retrieve all profiles from Firestore
            async getAllProfiles() {
                const controller = new userAdminAllProfilesController();
                return await controller.getAllProfiles();
            }

       
    // Display all profiles in the table
    // Display all profiles in the table
    displayProfiles(profileList) {
        const table = document.getElementById("data-table");
        table.innerHTML = "";

        const displayedUserTypes = new Set();

        // ðŸ‘‰ Sort by firstName alphabetically, then by lastName numerically
        profileList.sort((a, b) => {
            // First compare by firstName alphabetically
            const firstNameCompare = a.firstName.localeCompare(b.firstName);
            if (firstNameCompare !== 0) return firstNameCompare;

            // If firstName is the same, compare numerically by lastName
            const numA = this.extractNumberFromLastName(a.lastName);
            const numB = this.extractNumberFromLastName(b.lastName);
            return numA - numB;
        });

        profileList.forEach((profile) => {
            if (profile.userType && !displayedUserTypes.has(profile.userType)) {
                displayedUserTypes.add(profile.userType);

                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${profile.userType.charAt(0).toUpperCase() + profile.userType.slice(1)}</td>
                    <td>${profile.userStatus || "Active"}</td>
                    <td>
                        <button class="search-profile-btn" data-type="${profile.userType}">Search Profile</button>
                        <button class="delete-profile-btn" data-type="${profile.userType}">Delete Profile</button>
                    </td>
                `;
                table.appendChild(row);
            }
        });

        this.addSearchProfileListeners();
        this.addDeleteProfileListeners();
    }

    // Search Profile Event Listeners
    addSearchProfileListeners() {
        const searchButtons = document.querySelectorAll(".search-profile-btn");
        searchButtons.forEach(button => {
            button.addEventListener("click", async (event) => {
                const userType = event.target.getAttribute("data-type");
                await this.displayProfileDetails(userType);
            });
        });
    }

    // Display profile details by userType
    async displayProfileDetails(userType) {
        const users = await this.controller.searchProfile(userType);
        const container = document.getElementById("profile-details-container");

        if (users.length > 0) {
            container.innerHTML = `<h3>Users with profile type "${userType}":</h3>`;

            // ðŸ‘‰ Sort inside profile details too (first by firstName and then by lastName numerically)
            users.sort((a, b) => {
                const firstNameCompare = a.firstName.localeCompare(b.firstName);
                if (firstNameCompare !== 0) return firstNameCompare;

                const numA = this.extractNumberFromLastName(a.lastName);
                const numB = this.extractNumberFromLastName(b.lastName);
                return numA - numB;
            });

            users.forEach(user => {
                container.innerHTML += `
                    <div class="profile-card">
                        <p><strong>Name:</strong> ${user.firstName} ${user.lastName}</p>
                        <p><strong>Email:</strong> ${user.email}</p>
                        <p><strong>Status:</strong> ${user.userStatus}</p>
                        <hr/>
                    </div>
                `;
            });
        } else {
            container.innerHTML = `<p style="color: red;">No users found with profile type "${userType}"</p>`;
        }
    }

    // Delete profiles by userType
    async deleteProfile(userType) {
        try {
            const profileEntityInstance = new profileEntity();
            const message = await profileEntityInstance.deleteProfileByUserType(userType);
            alert(message);

            // Remove rows after deletion
            const rows = document.querySelectorAll("#admin-table tbody tr");
            rows.forEach(row => {
                const rowUserType = row.cells[0].textContent.trim().toLowerCase();
                if (rowUserType === userType.toLowerCase()) {
                    row.remove();
                }
            });

        } catch (error) {
            alert(`Error deleting profiles with userType "${userType}": ${error.message}`);
        }
    }

    // Add Delete button listeners
    addDeleteProfileListeners() {
        const deleteButtons = document.querySelectorAll(".delete-profile-btn");
        deleteButtons.forEach(button => {
            button.addEventListener("click", async (event) => {
                const userType = event.target.dataset.type;
                if (!userType) {
                    console.error("User type is missing!");
                    alert("User type is missing. Unable to proceed.");
                    return;
                }

                const confirmed = confirm(`Are you sure you want to delete all profiles with the userType "${userType}"?`);
                if (confirmed) {
                    await this.deleteProfile(userType);
                }
            });
        });
    }
}

// Run after DOM is fully loaded
window.addEventListener("DOMContentLoaded", async () => {
    const adminPage = new AdminProfilePage();
    const profiles = await adminPage.getAllProfiles();
    adminPage.displayProfiles(profiles);
});
    </script>
</body>
</html>
